#!/bin/bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

BREW_INSTALL_SUCCESS=false

handle_error() {
	if [ "$BREW_INSTALL_SUCCESS" = "false" ]; then
		unset HOMEBREW_PREFIX
		unset HOMEBREW_CELLAR
		unset HOMEBREW_REPOSITORY
		unset HOMEBREW_BREW_GIT_REMOTE
		unset HOMEBREW_CORE_GIT_REMOTE
		unset HOMEBREW_BOTTLE_DOMAIN
		unset HOMEBREW_NO_AUTO_UPDATE
	fi

    chezmoi reset state --force
}
trap handle_error ERR

HOME={{- .chezmoi.homeDir }}
LOCAL_DIR="$HOME/.local"
BIN_DIR="$HOME/.local/bin"
SHARE_DIR="$HOME/.local/share"
OPT_DIR="$HOME/opt"

INSTALL_DIR="$LOCAL_DIR/brew"

MAX_RETRIES=3

mkdir -p "$LOCAL_DIR" "$BIN_DIR" "$SHARE_DIR" "$OPT_DIR"

install_brew() {
	if command -v brew &> /dev/null && brew --version &> /dev/null; then
		log_success "Detect brew: $(brew --version | head -n1)"
		BREW_INSTALL_SUCCESS=true
		return 0
	fi

	log_info "Installing Homebrew to local directory..."
	if [ -d "$INSTALL_DIR" ]; then
		log_warn "Install directory exists, removing: $INSTALL_DIR"
		rm -rf "$INSTALL_DIR"
	fi

	export HOMEBREW_PREFIX="$LOCAL_DIR/brew"
	export HOMEBREW_CELLAR="$LOCAL_DIR/brew/Cellar"
	export HOMEBREW_REPOSITORY="$LOCAL_DIR/brew"
	export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git"
	export HOMEBREW_CORE_GIT_REMOTE="https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git"
	export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles"
	export HOMEBREW_NO_AUTO_UPDATE=1

	RETRY_COUNT=0
	while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
		if git clone https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git "$INSTALL_DIR" && \
		   mkdir -p "$INSTALL_DIR/Library/Taps/homebrew" && \
		   git clone https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git "$INSTALL_DIR/Library/Taps/homebrew/homebrew-core" && \
		   chmod +x "$INSTALL_DIR/bin/brew"; then
			log_success "Homebrew installed successfully."
			break
		else
			RETRY_COUNT=$((RETRY_COUNT + 1))
			log_warn "Install failed, retrying... ($RETRY_COUNT/$MAX_RETRIES)"
			if [ -d "$INSTALL_DIR" ]; then
				rm -rf "$INSTALL_DIR"
			fi
			sleep 1
		fi
	done
	if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
		log_error "Failed to install Homebrew after $MAX_RETRIES attempts"
		log_info "Please rerun, or make sure that brew is available"
		exit 1
	fi
	log_success "Homebrew installation completed"
	eval "$("$HOME/.local/brew/bin/brew" shellenv)"
	BREW_INSTALL_SUCCESS=true
}

declare -A PKG_CMD_MAP=(
{{- range $pkg, $cmd := .necessary_pkg_cmd_map }}
    ["{{ $pkg }}"]="{{ $cmd }}"
{{- end }}
)

is_package_installed() {
    local package="$1"
    local cmd_name="${PKG_CMD_MAP[$package]}"
    
    if command -v "$cmd_name" >/dev/null 2>&1; then
        return 0
    fi
    return 1
}

install_package() {
    local package="$1"
    
    if is_package_installed "$package"; then
        log_success "$package already installed"
        return 0
    fi
    
    log_info "Installing: $package"
    
    local retry_count=0
    while [ $retry_count -lt $MAX_RETRIES ]; do
        if brew install "$package"; then
            log_success "Installed: $package"
            return 0
        else
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $MAX_RETRIES ]; then
                log_warn "Install $package failed, retrying... ($retry_count/$MAX_RETRIES)"
				brew cleanup "$package" 2>/dev/null || true
                sleep 1
            else
                log_error "Failed to install $package after $MAX_RETRIES attempts"
                return 1
            fi
        fi
    done
}

install_necessary_packages() {
    log_info "Installing necessary packages..."
    log_info "Packages to install: ${!PKG_CMD_MAP[*]}"
    
    local failed_packages=()
    
    for package in "${!PKG_CMD_MAP[@]}"; do
        if ! install_package "$package"; then
            failed_packages+=("$package")
        fi
    done
    
    if [ ${#failed_packages[@]} -eq 0 ]; then
        log_success "All necessary packages installed successfully"
    else
        log_error "The following packages failed to install: ${failed_packages[*]}"
        log_info "You can try to install them manually later"
        return 1
    fi
}

verify_installation() {
    log_info "Verifying installation..."
    
    local missing_packages=()
    
    for package in "${!PKG_CMD_MAP[@]}"; do
        if ! is_package_installed "$package"; then
            missing_packages+=("$package")
        fi
    done
    
    if [ ${#missing_packages[@]} -eq 0 ]; then
        log_success "All packages verified successfully"
    else
        log_warn "The following packages may need manual installation: ${missing_packages[*]}"
    fi
}

main() {
	install_brew

    log_info "Starting package installation with Homebrew"
    
    install_necessary_packages
    verify_installation
    
    log_success "Package installation completed"
}

main "$@"
